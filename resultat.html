<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vivario ‚Äî Fin de s√©ance</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);font-size:12px}
    .hrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .section{margin-top:18px}
    .muted{opacity:.78}
    .small{font-size:12px}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .grid{display:grid;gap:10px;margin-top:10px}
    .list{margin:10px 0 0;padding:0;list-style:none;display:grid;gap:10px}
    .hero{
      margin-top:12px;padding:16px;border-radius:18px;
      background:linear-gradient(180deg, rgba(120,160,255,.18), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.12);
      position:relative;overflow:hidden;
    }
    .hero::after{
      content:"";position:absolute;inset:-40px -60px auto auto;
      width:220px;height:220px;
      background:radial-gradient(circle, rgba(120,160,255,.25), transparent 60%);
      filter:blur(2px);opacity:.9;pointer-events:none;
      animation:floaty 8s ease-in-out infinite;
    }
    @keyframes floaty{0%,100%{transform:translate(0,0)}50%{transform:translate(-18px,14px)}}
    .big{font-size:18px;line-height:1.4;margin:0}
    .sub{margin:8px 0 0;opacity:.88;line-height:1.55}
    .chiprow{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);opacity:.92}
    .micro{margin-top:12px;padding:12px;border-radius:14px;background:rgba(255,255,255,.05);border:1px dashed rgba(255,255,255,.16);}
    .breathRow{display:flex;align-items:center;gap:14px;flex-wrap:wrap;margin-top:10px;}
    .breathWrap{width:110px;height:110px;border-radius:999px;display:grid;place-items:center;position:relative;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);overflow:hidden;}
    .breathGlow{position:absolute;inset:-30px;background:radial-gradient(circle, rgba(120,160,255,.22), transparent 60%);opacity:.9;pointer-events:none;}
    .breathBall{width:62px;height:62px;border-radius:999px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.20);transition:transform .6s ease;}
    .breathBall.run{animation:breathCycle 12s ease-in-out infinite;}
    @keyframes breathCycle{0%{transform:scale(1.00)}33%{transform:scale(1.36)}50%{transform:scale(1.36)}100%{transform:scale(1.00)}}
    .breathText{display:grid;gap:6px;min-width:200px;}
    .breathPhase{font-size:14px;opacity:.95;}
    .breathTimer{font-size:12px;opacity:.78;}
    .breathBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;}
    .miniBtn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:inherit;text-decoration:none;font-size:14px;cursor:pointer;}
    .miniBtn:hover{background:rgba(255,255,255,.09)}
    .miniBtn:active{transform:scale(.99)}
    .item{padding:12px 12px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);animation:rise .35s ease both;}
    .k{font-size:12px;opacity:.82;margin-bottom:6px}
    .v{font-size:15px;line-height:1.55;white-space:pre-wrap}
    .sc{padding:14px;border-radius:18px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);animation:rise .35s ease both;}
    .sc h3{margin:0 0 8px;font-size:16px}
    .sc p{margin:0;font-size:14px;line-height:1.65;opacity:.96;white-space:pre-wrap}
    .sc .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .finalNote{margin-top:14px;padding:14px;border-radius:18px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);animation:rise .45s ease both;}
    @keyframes rise{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(20,20,25,.92);border:1px solid rgba(255,255,255,.14);padding:10px 12px;border-radius:12px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .18s ease, transform .18s ease;z-index:9999;max-width:92vw;}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px);}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="hrow">
        <h1 style="margin:0">Vivario</h1>
        <span class="badge">v1.1</span>
      </div>

      <div class="hero">
        <p class="big" id="heroTitle">Merci d‚Äôavoir pris ce temps.</p>
        <p class="sub" id="heroText">Tu as le droit d‚Äôavancer doucement, √† ton rythme.</p>

        <div class="chiprow" id="tagRow" style="display:none"></div>

        <div class="micro">
          <strong>üåø Micro-pause respiratoire (facultatif)</strong>
          <div class="muted" style="margin-top:6px;line-height:1.55">
            Inspire 4s‚Ä¶ garde 2s‚Ä¶ expire 6s. Lance l‚Äôanimation si tu veux (30 secondes).
          </div>

          <div class="breathRow">
            <div class="breathWrap" aria-hidden="true">
              <div class="breathGlow"></div>
              <div id="breathBall" class="breathBall"></div>
            </div>
            <div class="breathText">
              <div class="breathPhase" id="breathPhase">Pr√™t ?</div>
              <div class="breathTimer" id="breathTimer">30s</div>
              <div class="breathBtns">
                <button class="miniBtn" id="breathStart" type="button">‚ñ∂Ô∏è D√©marrer</button>
                <button class="miniBtn" id="breathStop" type="button">‚è∏Ô∏è Stop</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2 style="margin:0">Ce que tu as partag√©</h2>
        <ul id="resumeList" class="list"></ul>
        <p id="resumeEmpty" class="muted" style="display:none;margin-top:10px">
          Aucun r√©sum√© √† afficher. (Refais une s√©ance.)
        </p>
      </div>

      <div class="section">
        <h2 style="margin:0">Sc√©narios adaptatifs</h2>
        <div id="scenarios" class="grid"></div>
        <p id="scEmpty" class="muted" style="display:none;margin-top:10px">Aucun sc√©nario √† afficher.</p>
      </div>

      <div class="finalNote" id="finalNote" style="display:none">
        <div class="k">Pour finir (juste pour toi)</div>
        <div class="v" id="finalText"></div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="miniBtn" id="keepAll" type="button">üìå Je garde ce r√©sultat</button>
        </div>
      </div>

      <div class="section">
        <h2 style="margin:0">Et maintenant ?</h2>
        <p class="muted" style="margin:8px 0 0;line-height:1.6">
          Si quelque chose r√©sonne, garde-le. Si rien ne r√©sonne, c‚Äôest OK aussi.
          Tu peux revenir quand tu veux.
        </p>

        <div class="btnrow">
          <a class="btn primary" href="questionnaire.html">Refaire une s√©ance</a>
          <a class="btn" id="avisBtn" href="#">Donner un avis</a>
          <a class="btn ghost" href="accueil.html">‚Üê Accueil</a>
        </div>
      </div>

      <div class="sep" style="margin-top:16px"></div>
      <p class="small muted" style="margin:0;line-height:1.55">
        Confidentialit√© : Vivario ne remplace pas un professionnel de sant√©.<br>
        Si tu es en d√©tresse ou en danger imm√©diat, contacte les urgences (15/112) ou un proche.
      </p>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const STORAGE_KEY = "vivario_session_v1_1";
    const GOOGLE_FORMS_URL = "https://docs.google.com/forms/d/e/1FAIpQLSczOz8rRS2o4pS8mf6vH4BDMNIxgmR3dVSEgPEJt5vsEGdKPg/viewform?usp=header";

    const resumeList = document.getElementById("resumeList");
    const resumeEmpty = document.getElementById("resumeEmpty");
    const scWrap = document.getElementById("scenarios");
    const scEmpty = document.getElementById("scEmpty");
    const heroTitle = document.getElementById("heroTitle");
    const heroText = document.getElementById("heroText");
    const tagRow = document.getElementById("tagRow");
    const avisBtn = document.getElementById("avisBtn");
    const toast = document.getElementById("toast");
    const finalNote = document.getElementById("finalNote");
    const finalText = document.getElementById("finalText");
    const keepAll = document.getElementById("keepAll");

    // respiration
    const breathBall  = document.getElementById("breathBall");
    const breathPhase = document.getElementById("breathPhase");
    const breathTimer = document.getElementById("breathTimer");
    const breathStart = document.getElementById("breathStart");
    const breathStop  = document.getElementById("breathStop");

    avisBtn.href = GOOGLE_FORMS_URL;
    avisBtn.target = "_blank";
    avisBtn.rel = "noopener";

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove("show"), 1600);
    }

    function readSession(){
      try{
        const v = localStorage.getItem(STORAGE_KEY);
        return v ? JSON.parse(v) : null;
      }catch(e){ return null; }
    }

    function renderTags(tags){
      const t = (tags || []).slice(0, 10);
      if (!t.length) { tagRow.style.display = "none"; return; }
      tagRow.style.display = "flex";
      tagRow.innerHTML = "";
      t.forEach(x => {
        const c = document.createElement("span");
        c.className = "chip";
        c.textContent = String(x);
        tagRow.appendChild(c);
      });
    }

    // ‚úÖ Phrase finale 100% fiable : uniquement profile (mood/themes/needs/energy)
    function buildFinalPhrase(profile){
      const mood = profile?.mood || "clarification";
      const focus = Array.isArray(profile?.focus) ? profile.focus : [];
      const needs = Array.isArray(profile?.needs) ? profile.needs : [];
      const energy = Array.isArray(profile?.energy) ? profile.energy : [];

      const themeTxt = focus.length ? `sur ${focus.join(" et ")}` : "sur ce qui compte pour toi";

      // morceaux 100% d√©terministes
      const moodLine = ({
        fatigue: "Si tu es fatigu√©(e), tu n‚Äôas rien √† prouver. La douceur est une force.",
        flou: "Si c‚Äôest flou, ce n‚Äôest pas un √©chec : c‚Äôest souvent un signe que plusieurs choses se superposent.",
        sortie: "Si tu ne te sens pas aid√©(e) aujourd‚Äôhui, c‚Äôest OK. Tu n‚Äôas rien ‚Äúrat√©‚Äù.",
        clarification: "M√™me quand tout va globalement bien, faire le point peut t‚Äôaider √† respirer autrement."
      })[mood] || "Tu peux avancer sans te brusquer.";

      const needLine = needs.includes("moins_seul") ? "Tu m√©rites de ne pas porter √ßa seul(e)." :
                      needs.includes("comprendre") ? "Clarifier n‚Äôest pas tout r√©soudre : c‚Äôest d√©j√† se soutenir." :
                      needs.includes("recul") ? "Prendre du recul, c‚Äôest parfois la r√©ponse la plus saine." :
                      needs.includes("presence") ? "Parfois, √™tre simplement l√† suffit. Pas d‚Äôobjectif, juste toi." :
                      "Tu as le droit de prendre ce temps, juste pour toi.";

      const energyLine = energy.includes("faible") ? "Aujourd‚Äôhui, fais petit. Petit, c‚Äôest parfait." :
                        energy.includes("lecture") ? "Tu peux simplement relire ces mots plus tard, sans rien forcer." :
                        "Va √† ton rythme. C‚Äôest d√©j√† bien.";

      return `${moodLine}\n\nAujourd‚Äôhui, tu as orient√© ta s√©ance ${themeTxt}.\n\n${needLine}\n${energyLine}`;
    }

    function niceHero(profile){
      const mood = profile?.mood || "clarification";
      if (mood === "fatigue") {
        heroTitle.textContent = "Tu as tenu. Et c‚Äôest d√©j√† beaucoup.";
        heroText.textContent = "Ici, tu peux souffler un peu. Rien √† prouver. Juste te m√©nager.";
        return;
      }
      if (mood === "flou") {
        heroTitle.textContent = "Tu peux respirer un peu, l√†.";
        heroText.textContent = "Le flou n‚Äôest pas un vide. On peut avancer sans tout comprendre d‚Äôun coup.";
        return;
      }
      if (mood === "sortie") {
        heroTitle.textContent = "Merci d‚Äôavoir essay√©.";
        heroText.textContent = "M√™me si Vivario ne t‚Äôaide pas aujourd‚Äôhui, ce temps reste valable. Tu peux revenir plus tard.";
        return;
      }
      heroTitle.textContent = "Merci d‚Äôavoir pris ce temps.";
      heroText.textContent = "Tu as le droit d‚Äôavancer doucement, √† ton rythme.";
    }

    function makeScenarioText(s){
      const title = s.title || "Sc√©nario";
      const text = s.text || "";
      return `Vivario ‚Äî ${title}\n\n${text}\n\n(√Ä relire quand tu veux.)`;
    }

    async function copyToClipboard(str){
      try{
        await navigator.clipboard.writeText(str);
        showToast("üìå Copi√© !");
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = str;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); showToast("üìå Copi√© !"); }
        catch(err){ showToast("Impossible de copier automatiquement."); }
        document.body.removeChild(ta);
      }
    }

    // ‚úÖ respiration 30s (manuel)
    let breathLeft = 30;
    let breathTick = null;
    let phaseTick = null;

    function stopBreath(){
      breathBall.classList.remove("run");
      breathPhase.textContent = "Pause.";
      clearInterval(breathTick); clearInterval(phaseTick);
      breathTick = null; phaseTick = null;
    }

    function startBreath(){
      stopBreath();
      breathLeft = 30;
      breathTimer.textContent = "30s";
      breathBall.classList.add("run");

      const phaseAt = (sec) => sec < 4 ? "Inspire‚Ä¶ (4s)" : (sec < 6 ? "Garde‚Ä¶ (2s)" : "Expire‚Ä¶ (6s)");
      const start = Date.now();
      breathPhase.textContent = "Inspire‚Ä¶ (4s)";

      phaseTick = setInterval(() => {
        const elapsed = (Date.now() - start) / 1000;
        const inCycle = elapsed % 12;
        breathPhase.textContent = phaseAt(inCycle);
      }, 200);

      breathTick = setInterval(() => {
        breathLeft -= 1;
        breathTimer.textContent = breathLeft + "s";
        if (breathLeft <= 0){
          stopBreath();
          breathPhase.textContent = "Bien. Reviens doucement.";
          showToast("üåø Micro-pause termin√©e");
        }
      }, 1000);
    }

    breathStart.addEventListener("click", startBreath);
    breathStop.addEventListener("click", stopBreath);

    function render(){
      const session = readSession();
      const profile = session?.profile || {};
      const tags = Array.isArray(profile?.tags) ? profile.tags : [];

      niceHero(profile);
      renderTags(tags);

      // r√©sum√©
      resumeList.innerHTML = "";
      if (!session || !Array.isArray(session.answers) || !session.answers.length) {
        resumeEmpty.style.display = "block";
      } else {
        resumeEmpty.style.display = "none";
        session.answers.forEach((a, idx) => {
          const li = document.createElement("li");
          li.className = "item";
          li.style.animationDelay = (idx * 25) + "ms";

          const k = document.createElement("div");
          k.className = "k";
          k.textContent = a.question || a.theme || "Ton chemin";

          const v = document.createElement("div");
          v.className = "v";
          v.textContent = a.answer || "";

          li.appendChild(k);
          li.appendChild(v);
          resumeList.appendChild(li);
        });
      }

      // sc√©narios adaptatifs (plusieurs)
      scWrap.innerHTML = "";
      const sc = session && Array.isArray(session.scenarios) ? session.scenarios : [];
      if (!sc.length) {
        scEmpty.style.display = "block";
      } else {
        scEmpty.style.display = "none";
        sc.forEach((s, idx) => {
          const box = document.createElement("div");
          box.className = "sc";
          box.style.animationDelay = (idx * 35) + "ms";

          const h = document.createElement("h3");
          h.textContent = s.title || "Sc√©nario";

          const p = document.createElement("p");
          p.textContent = s.text || "";

          const actions = document.createElement("div");
          actions.className = "actions";

          const keep = document.createElement("a");
          keep.href = "#";
          keep.className = "miniBtn";
          keep.textContent = "üìå Garder ce sc√©nario";
          keep.addEventListener("click", (e) => {
            e.preventDefault();
            copyToClipboard(makeScenarioText(s));
          });

          actions.appendChild(keep);

          box.appendChild(h);
          box.appendChild(p);
          box.appendChild(actions);
          scWrap.appendChild(box);
        });
      }

      // phrase finale fiable
      const phrase = buildFinalPhrase(profile);
      finalText.textContent = phrase;
      finalNote.style.display = "block";

      // bouton ‚Äúje garde ce r√©sultat‚Äù
      keepAll.addEventListener("click", () => {
        const parts = [];
        parts.push("Vivario ‚Äî Mon r√©sultat\n");
        if (session?.answers?.length) {
          parts.push("R√©sum√© :");
          session.answers.forEach(a => parts.push(`- ${a.question || a.theme}: ${a.answer}`));
          parts.push("");
        }
        if (session?.scenarios?.length) {
          parts.push("Sc√©narios :");
          session.scenarios.forEach(s => {
            parts.push(`\n${s.title}\n${s.text}`);
          });
          parts.push("");
        }
        parts.push("Phrase finale :\n" + phrase);
        copyToClipboard(parts.join("\n"));
      });
    }

    render();
  </script>
</body>
</html>