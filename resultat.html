<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vivario — Résultat</title>
  <link rel="stylesheet" href="style.css?v=3" />
</head>
<body class="page-result">

  <main class="wrap">
    <header class="top">
      <h1 class="brand">Vivario</h1>
      <p class="muted">Merci. Prends une seconde…</p>
    </header>

    <section class="card breathe-card" id="breatheCard">
      <div class="breathe-orb" aria-hidden="true"></div>

      <h2 id="resultTitle">Ton résultat</h2>
      <p class="muted" id="resultMeta"></p>

      <div class="result-block" id="finalMessage"></div>

      <div class="actions">
        <button class="btn primary" id="btnStartBreath">▶ Lancer la respiration</button>
        <button class="btn ghost" id="btnStopBreath">⏸ Stop</button>
        <a class="btn ghost" href="accueil.html?v=3">↩ Accueil</a>
      </div>

      <p class="tiny muted">
        Confidentialité : Vivario ne remplace pas un professionnel de santé.
        Si danger immédiat : 15 / 112.
      </p>

      <!-- ✅ UI respiration guidée (devant / visible) -->
      <div id="breathUI" class="breath-ui" hidden>
        <div class="breath-circle" id="breathCircle" aria-hidden="true"></div>
        <div class="breath-label" id="breathLabel">Inspire</div>
        <div class="breath-sub" id="breathSub">4 s</div>
        <button class="breath-close" id="breathClose" type="button">✕</button>
      </div>
    </section>

    <section class="card feedback-card">
      <h3 style="margin:0 0 6px;">Un avis rapide ?</h3>
      <p class="muted" style="margin:0 0 12px; line-height:1.45;">
        Ton retour m’aide à rendre Vivario plus utile.
      </p>
      <div class="actions" style="margin-top:0;">
        <a class="btn primary" href="avis.html?v=3">✍️ Donner un avis</a>
        <a class="btn ghost" href="questionnaire.html?v=3">↻ Refaire le questionnaire</a>
      </div>
    </section>

    <section class="card" id="scenarios"></section>
  </main>

  <script src="sound.js?v=3"></script>

  <script>
    const STORAGE_KEY = "vivario_session_v1_1";

    // Réglages respiration (comme au début)
    const BREATH = { inhale: 4, hold: 0, exhale: 6 };

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function render() {
      const raw = localStorage.getItem(STORAGE_KEY);
      const finalEl = document.getElementById("finalMessage");
      const metaEl = document.getElementById("resultMeta");
      const scEl = document.getElementById("scenarios");

      if (!raw) {
        finalEl.textContent = "Session introuvable. Reviens au questionnaire.";
        metaEl.textContent = "";
        scEl.innerHTML = "";
        return;
      }

      const session = JSON.parse(raw);

      metaEl.textContent =
        `Version ${session.version} • ${new Date(session.createdAt).toLocaleString("fr-FR")}`;

      finalEl.innerHTML =
        "<p>" + esc(session.finalMessage).replace(/\n\n/g, "</p><p>") + "</p>";

      const scenarios = Array.isArray(session.scenarios) ? session.scenarios : [];
      if (!scenarios.length) {
        scEl.innerHTML = "<h3>Scénarios</h3><p class='muted'>Aucun scénario disponible.</p>";
        return;
      }

      scEl.innerHTML = "<h3>Scénarios</h3>" + scenarios.map(s => `
        <div class="scenario">
          <h4>${esc(s.title)}</h4>
          <div class="scenario-text">${esc(s.text).replace(/\n\n/g,"<br><br>")}</div>
        </div>
      `).join("");
    }

    // -----------------------
    // Respiration guidée UI
    // -----------------------
    let raf = null;
    let t0 = 0;
    let running = false;

    const ui = () => ({
      wrap: document.getElementById("breathUI"),
      circle: document.getElementById("breathCircle"),
      label: document.getElementById("breathLabel"),
      sub: document.getElementById("breathSub")
    });

    function cycleTotal(){
      return BREATH.inhale + BREATH.hold + BREATH.exhale + BREATH.hold;
    }

    function phaseAt(t){
      const inh = BREATH.inhale;
      const hold = BREATH.hold;
      const exh = BREATH.exhale;

      if (t < inh) return { name:"Inspire", secLeft: Math.ceil(inh - t), p: t/inh, mode:"inhale" };
      t -= inh;

      if (hold > 0 && t < hold) return { name:"Bloque", secLeft: Math.ceil(hold - t), p: 1, mode:"holdHigh" };
      if (hold > 0) t -= hold;

      if (t < exh) return { name:"Expire", secLeft: Math.ceil(exh - t), p: t/exh, mode:"exhale" };
      t -= exh;

      if (hold > 0) return { name:"Bloque", secLeft: Math.ceil(hold - t), p: 0, mode:"holdLow" };
      return { name:"Expire", secLeft: 1, p: 0, mode:"exhale" };
    }

    function setCircleScale(p, mode){
      // scale doux et lisible
      // inhale: 0.78 -> 1.06
      // exhale: 1.06 -> 0.78
      const min = 0.78, max = 1.06;
      let s = min;

      if (mode === "inhale") s = min + (max - min) * p;
      else if (mode === "exhale") s = max - (max - min) * p;
      else if (mode === "holdHigh") s = max;
      else if (mode === "holdLow") s = min;

      ui().circle.style.transform = `scale(${s})`;
    }

    function loop(now){
      if (!running) return;

      const total = cycleTotal();
      const elapsed = (now - t0) / 1000;
      const t = elapsed % total;

      const ph = phaseAt(t);
      ui().label.textContent = ph.name;
      ui().sub.textContent = `${ph.secLeft} s`;
      setCircleScale(ph.p, ph.mode);

      raf = requestAnimationFrame(loop);
    }

    async function startBreath(){
      if (running) return;
      running = true;

      // UI visible + focus respiration
      ui().wrap.hidden = false;
      document.body.classList.add("breathing");

      // Son respiration (breath_cycle.mp3) + coupe ambiance pendant l’exercice
      await window.VivarioSound?.startBreathing?.({
        inhale: BREATH.inhale,
        hold: BREATH.hold,
        exhale: BREATH.exhale,
        affectAmbience: false,
        affectBreath: true,
        muteAmbienceWhileBreath: true
      });

      t0 = performance.now();
      raf = requestAnimationFrame(loop);
    }

    function stopBreath(){
      running = false;
      if (raf) cancelAnimationFrame(raf);
      raf = null;

      document.body.classList.remove("breathing");
      ui().wrap.hidden = true;

      window.VivarioSound?.stopBreathing?.();
    }

    document.addEventListener("DOMContentLoaded", () => {
      render();

      document.getElementById("btnStartBreath").addEventListener("click", startBreath);
      document.getElementById("btnStopBreath").addEventListener("click", stopBreath);
      document.getElementById("breathClose").addEventListener("click", stopBreath);
    });
  </script>
</body>
</html>