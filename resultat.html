<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vivario — Résultat</title>
  <link rel="stylesheet" href="style.css?v=3" />
</head>
<body class="page-result">

  <main class="wrap">
    <header class="top">
      <h1 class="brand">Vivario</h1>
      <p class="muted">Merci. Prends une seconde…</p>
    </header>

    <section class="card breathe-card" id="breatheCard">
      <div class="breathe-orb" aria-hidden="true"></div>

      <h2 id="resultTitle">Ton résultat</h2>
      <p class="muted" id="resultMeta"></p>

      <div class="result-block" id="finalMessage"></div>

      <div class="actions">
        <button class="btn primary" id="btnStartBreath">▶ Lancer la respiration</button>
        <button class="btn ghost" id="btnStopBreath">⏸ Stop</button>
        <a class="btn ghost" href="accueil.html?v=3">↩ Accueil</a>
      </div>

      <p class="tiny muted">
        Confidentialité : Vivario ne remplace pas un professionnel de santé.
        Si danger immédiat : 15 / 112.
      </p>
    </section>

    <section class="card" id="scenarios"></section>
  </main>

  <!-- ✅ IMPORTANT : sound.js AVANT le script qui appelle VivarioSound -->
  <script src="sound.js?v=7"></script>

  <script>
    const STORAGE_KEY = "vivario_session_v1_1";
    let breathing = false;

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function render() {
      const raw = localStorage.getItem(STORAGE_KEY);
      const finalEl = document.getElementById("finalMessage");
      const metaEl = document.getElementById("resultMeta");
      const scEl = document.getElementById("scenarios");

      if (!raw) {
        finalEl.textContent = "Session introuvable. Reviens au questionnaire.";
        metaEl.textContent = "";
        scEl.innerHTML = "";
        return;
      }

      const session = JSON.parse(raw);

      metaEl.textContent =
        `Version ${session.version} • ${new Date(session.createdAt).toLocaleString("fr-FR")}`;

      finalEl.innerHTML =
        "<p>" + esc(session.finalMessage).replace(/\n\n/g, "</p><p>") + "</p>";

      const scenarios = Array.isArray(session.scenarios) ? session.scenarios : [];
      if (!scenarios.length) {
        scEl.innerHTML = "<h3>Scénarios</h3><p class='muted'>Aucun scénario disponible.</p>";
        return;
      }

      scEl.innerHTML = "<h3>Scénarios</h3>" + scenarios.map(s => `
        <div class="scenario">
          <h4>${esc(s.title)}</h4>
          <div class="scenario-text">${esc(s.text).replace(/\n\n/g,"<br><br>")}</div>
        </div>
      `).join("");
    }

    async function startBreath() {
      breathing = true;
      document.body.classList.add("breathing");

      // ✅ Ici : souffle = breath_cycle.mp3
      // - affectBreath: true => joue breath_cycle
      // - muteAmbienceWhileBreath: true => coupe l'ambiance pendant l'exercice
      // - affectAmbience: false => l'ambiance NE "respire" pas (recommandé)
      await window.VivarioSound?.startBreathing?.({
        inhale: 4,
        hold: 0,
        exhale: 6,
        affectAmbience: false,
        affectBreath: true,
        muteAmbienceWhileBreath: true
      });
    }

    function stopBreath() {
      breathing = false;
      document.body.classList.remove("breathing");
      window.VivarioSound?.stopBreathing?.();
    }

    document.addEventListener("DOMContentLoaded", () => {
      render();

      document.getElementById("btnStartBreath").addEventListener("click", startBreath);
      document.getElementById("btnStopBreath").addEventListener("click", stopBreath);
    });
  </script>
</body>
</html>