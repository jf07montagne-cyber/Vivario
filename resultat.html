<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vivario ‚Äî R√©sultat</title>
  <link rel="stylesheet" href="style.css?v=300" />
</head>
<body class="page-result">

  <main class="wrap">
    <header class="top">
      <h1 class="brand">Vivario</h1>
      <p class="muted">Merci. Prends une seconde‚Ä¶</p>
    </header>

    <!-- Carte ‚Äúatterrissage‚Äù -->
    <section class="card landing-card">
      <h2 style="margin:0 0 6px;">Tu peux souffler.</h2>
      <p class="muted" style="margin:0; line-height:1.5;">
        Ce qui suit est √©crit √† partir de tes r√©ponses. Rien n‚Äôest stock√© ailleurs que sur ton appareil.
      </p>

      <div class="actions" style="margin-top:12px;">
        <a class="btn primary" href="respiration.html?v=300">ü´Å Respiration guid√©e</a>
        <a class="btn ghost" href="accueil.html?v=300">‚Ü© Accueil</a>
      </div>
    </section>

    <section class="card breathe-card" id="breatheCard">
      <div class="breathe-orb" aria-hidden="true"></div>
      <div class="breathe-center" aria-hidden="true"></div>

      <h2 id="resultTitle" style="margin:0;">Ton r√©sultat</h2>
      <p class="muted" id="resultMeta"></p>

      <div class="result-block bigtext" id="finalMessage"></div>
    </section>

    <!-- Onglets sc√©narios -->
    <section class="card" id="scenariosCard">
      <div class="tabs" role="tablist" aria-label="Sc√©narios Vivario">
        <button class="tab active" role="tab" aria-selected="true" data-tab="main">Juste pour toi</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="step">Un pas concret</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="calm">Apaisement</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="norm">Normalisation</button>
      </div>

      <div class="tabpanes">
        <div class="pane active" role="tabpanel" id="pane-main"></div>
        <div class="pane" role="tabpanel" id="pane-step"></div>
        <div class="pane" role="tabpanel" id="pane-calm"></div>
        <div class="pane" role="tabpanel" id="pane-norm"></div>
      </div>
    </section>

    <!-- Carte avis -->
    <section class="card feedback-card">
      <h3 style="margin:0 0 6px;">Un avis rapide ?</h3>
      <p class="muted" style="margin:0 0 12px; line-height:1.45;">
        Ton retour m‚Äôaide √† rendre Vivario plus utile.
      </p>
      <div class="actions" style="margin-top:0;">
        <a class="btn primary" href="avis.html?v=300">‚úçÔ∏è Donner un avis</a>
        <a class="btn ghost" href="questionnaire.html?v=300">‚Üª Refaire le questionnaire</a>
      </div>
    </section>
  </main>

  <script src="sound.js?v=300"></script>

  <script>
    const STORAGE_KEY = "vivario_session_v1_1";

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function renderParagraphs(text){
      return "<p>" + esc(text).replace(/\n\n/g, "</p><p>") + "</p>";
    }

    function setActiveTab(key){
      document.querySelectorAll(".tab").forEach(btn => {
        const on = btn.dataset.tab === key;
        btn.classList.toggle("active", on);
        btn.setAttribute("aria-selected", on ? "true" : "false");
      });
      document.querySelectorAll(".pane").forEach(p => {
        p.classList.toggle("active", p.id === "pane-" + key);
      });
    }

    function render() {
      const raw = localStorage.getItem(STORAGE_KEY);

      const finalEl = document.getElementById("finalMessage");
      const metaEl = document.getElementById("resultMeta");

      if (!raw) {
        finalEl.textContent = "Session introuvable. Reviens au questionnaire.";
        metaEl.textContent = "";
        return;
      }

      const session = JSON.parse(raw);

      metaEl.textContent =
        `Version ${session.version} ‚Ä¢ ${new Date(session.createdAt).toLocaleString("fr-FR")}`;

      finalEl.innerHTML = renderParagraphs(session.finalMessage);

      const scenarios = Array.isArray(session.scenarios) ? session.scenarios : [];

      // fallback si pas de sc√©narios
      if (!scenarios.length) {
        document.getElementById("pane-main").innerHTML =
          "<h3 style='margin:0 0 6px;'>Sc√©narios</h3><p class='muted'>Aucun sc√©nario disponible.</p>";
        return;
      }

      // On remplit les 4 panes par key
      const map = {};
      scenarios.forEach(s => { if (s && s.key) map[s.key] = s; });

      function fillPane(key, defaultTitle){
        const pane = document.getElementById("pane-" + key);
        const s = map[key];
        if (!pane) return;

        const title = esc(s?.title || defaultTitle);
        const text = s?.text ? renderParagraphs(s.text) : "<p class='muted'>Indisponible.</p>";

        pane.innerHTML = `
          <h3 style="margin:0 0 10px;">${title}</h3>
          <div class="scenario-text">${text}</div>
        `;
      }

      fillPane("main", "Juste pour toi");
      fillPane("step", "Un pas concret");
      fillPane("calm", "Apaisement");
      fillPane("norm", "Normalisation");

      // titre onglet principal = celui du root (si diff√©rent)
      const mainTitle = map.main?.title;
      if (mainTitle) {
        const btnMain = document.querySelector('.tab[data-tab="main"]');
        if (btnMain) btnMain.textContent = mainTitle;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      render();

      document.querySelectorAll(".tab").forEach(btn => {
        btn.addEventListener("click", () => setActiveTab(btn.dataset.tab));
      });

      setActiveTab("main");
    });
  </script>
</body>
</html>