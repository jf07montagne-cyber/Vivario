<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vivario ‚Äî R√©sultat</title>
  <link rel="stylesheet" href="style.css?v=4" />
</head>
<body class="page-result">

  <main class="wrap">
    <header class="top">
      <h1 class="brand">Vivario</h1>
      <p class="muted">Merci. Prends une seconde‚Ä¶</p>
    </header>

    <section class="card breathe-card" id="breatheCard">
      <div class="breathe-orb" aria-hidden="true"></div>

      <h2 id="resultTitle">Ton r√©sultat</h2>
      <p class="muted" id="resultMeta"></p>

      <div class="result-block" id="finalMessage"></div>

      <div class="actions">
        <button class="btn primary" id="btnStartBreath">ü´Å Lancer la respiration</button>
        <button class="btn ghost" id="btnStopBreath">‚è∏ Stop</button>
        <a class="btn ghost" href="accueil.html?v=4">‚Ü© Accueil</a>
      </div>

      <p class="tiny muted">
        Confidentialit√© : Vivario ne remplace pas un professionnel de sant√©.
        Si danger imm√©diat : 15 / 112.
      </p>
    </section>

    <section class="card feedback-card">
      <h3 style="margin:0 0 6px;">Un avis rapide ?</h3>
      <p class="muted" style="margin:0 0 12px; line-height:1.45;">
        Ton retour m‚Äôaide √† rendre Vivario plus utile.
      </p>
      <div class="actions" style="margin-top:0;">
        <a class="btn primary" href="avis.html?v=4">‚úçÔ∏è Donner un avis</a>
        <a class="btn ghost" href="questionnaire.html?v=4">‚Üª Refaire le questionnaire</a>
      </div>
    </section>

    <section class="card" id="scenarios"></section>
  </main>

  <!-- ‚úÖ Overlay respiration (plein √©cran, guid√©, rond visible) -->
  <div id="breathOverlay" class="breath-overlay" hidden>
    <div class="breath-panel" role="dialog" aria-modal="true" aria-label="Respiration guid√©e">
      <button class="breath-x" id="breathClose" type="button" aria-label="Fermer">‚úï</button>

      <div class="breath-ring" id="breathRing" aria-hidden="true"></div>

      <div class="breath-text">
        <div class="breath-phase" id="breathPhase">Inspire</div>
        <div class="breath-seconds" id="breathSeconds">4 s</div>
      </div>

      <div class="breath-actions">
        <button class="btn primary" id="breathStop2" type="button">‚è∏ Stop</button>
      </div>

      <p class="tiny muted" style="margin-top:10px">
        Suis le rythme, sans forcer. Tu peux arr√™ter √† tout moment.
      </p>
    </div>
  </div>

  <script src="sound.js?v=4"></script>

  <script>
    const STORAGE_KEY = "vivario_session_v1_1";
    const BREATH = { inhale: 4, hold: 0, exhale: 6 };

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function render() {
      const raw = localStorage.getItem(STORAGE_KEY);
      const finalEl = document.getElementById("finalMessage");
      const metaEl = document.getElementById("resultMeta");
      const scEl = document.getElementById("scenarios");

      if (!raw) {
        finalEl.textContent = "Session introuvable. Reviens au questionnaire.";
        metaEl.textContent = "";
        scEl.innerHTML = "";
        return;
      }

      const session = JSON.parse(raw);

      metaEl.textContent =
        `Version ${session.version} ‚Ä¢ ${new Date(session.createdAt).toLocaleString("fr-FR")}`;

      finalEl.innerHTML =
        "<p>" + esc(session.finalMessage).replace(/\n\n/g, "</p><p>") + "</p>";

      const scenarios = Array.isArray(session.scenarios) ? session.scenarios : [];
      if (!scenarios.length) {
        scEl.innerHTML = "<h3>Sc√©narios</h3><p class='muted'>Aucun sc√©nario disponible.</p>";
        return;
      }

      scEl.innerHTML = "<h3>Sc√©narios</h3>" + scenarios.map(s => `
        <div class="scenario">
          <h4>${esc(s.title)}</h4>
          <div class="scenario-text">${esc(s.text).replace(/\n\n/g,"<br><br>")}</div>
        </div>
      `).join("");
    }

    // -----------------------
    // Respiration guid√©e overlay
    // -----------------------
    let raf = null;
    let t0 = 0;
    let running = false;

    const overlay = () => document.getElementById("breathOverlay");
    const ring = () => document.getElementById("breathRing");
    const phaseEl = () => document.getElementById("breathPhase");
    const secEl = () => document.getElementById("breathSeconds");

    function totalCycle(){ return BREATH.inhale + BREATH.hold + BREATH.exhale + BREATH.hold; }

    function phaseAt(t){
      const inh = BREATH.inhale, hold = BREATH.hold, exh = BREATH.exhale;

      if (t < inh) return { name:"Inspire", left: Math.ceil(inh - t), p: t/inh, mode:"inhale" };
      t -= inh;

      if (hold > 0 && t < hold) return { name:"Bloque", left: Math.ceil(hold - t), p: 1, mode:"holdHigh" };
      if (hold > 0) t -= hold;

      if (t < exh) return { name:"Expire", left: Math.ceil(exh - t), p: t/exh, mode:"exhale" };
      t -= exh;

      if (hold > 0) return { name:"Bloque", left: Math.ceil(hold - t), p: 0, mode:"holdLow" };
      return { name:"Expire", left: 1, p: 0, mode:"exhale" };
    }

    function applyScale(p, mode){
      const min = 0.78, max = 1.10;
      let s = min;
      if (mode === "inhale") s = min + (max - min) * p;
      else if (mode === "exhale") s = max - (max - min) * p;
      else if (mode === "holdHigh") s = max;
      else if (mode === "holdLow") s = min;

      ring().style.transform = `scale(${s})`;
    }

    function loop(now){
      if (!running) return;

      const t = ((now - t0) / 1000) % totalCycle();
      const ph = phaseAt(t);

      phaseEl().textContent = ph.name;
      secEl().textContent = `${ph.left} s`;
      applyScale(ph.p, ph.mode);

      raf = requestAnimationFrame(loop);
    }

    async function startBreath(){
      if (running) return;
      running = true;

      overlay().hidden = false;
      document.body.classList.add("breath-open");

      await window.VivarioSound?.startBreathing?.({
        inhale: BREATH.inhale,
        hold: BREATH.hold,
        exhale: BREATH.exhale,
        affectAmbience: false,
        affectBreath: true,
        muteAmbienceWhileBreath: true
      });

      t0 = performance.now();
      raf = requestAnimationFrame(loop);
    }

    function stopBreath(){
      running = false;
      if (raf) cancelAnimationFrame(raf);
      raf = null;

      window.VivarioSound?.stopBreathing?.();
      document.body.classList.remove("breath-open");
      overlay().hidden = true;
    }

    document.addEventListener("DOMContentLoaded", () => {
      render();

      document.getElementById("btnStartBreath").addEventListener("click", startBreath);
      document.getElementById("btnStopBreath").addEventListener("click", stopBreath);

      document.getElementById("breathClose").addEventListener("click", stopBreath);
      document.getElementById("breathStop2").addEventListener("click", stopBreath);

      overlay().addEventListener("click", (e) => {
        if (e.target.id === "breathOverlay") stopBreath();
      });
    });
  </script>
</body>
</html>