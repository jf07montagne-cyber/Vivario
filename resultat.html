<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vivario ‚Äî R√©sultat</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="page-result">

  <main class="wrap">
    <header class="top">
      <h1 class="brand">Vivario</h1>
      <p class="muted">Merci. Prends une seconde‚Ä¶</p>
    </header>

    <section class="card breathe-card" id="breatheCard">
      <div class="breathe-orb" aria-hidden="true"></div>

      <h2 id="resultTitle">Ton r√©sultat</h2>
      <p class="muted" id="resultMeta"></p>

      <div class="result-block" id="finalMessage"></div>

      <div class="actions">
        <button class="btn" id="btnStartBreath">‚ñ∂ Lancer la respiration</button>
        <button class="btn ghost" id="btnStopBreath">‚è∏ Stop</button>
      </div>

      <p class="tiny muted">
        Confidentialit√© : Vivario ne remplace pas un professionnel de sant√©.
        Si danger imm√©diat : 15 / 112.
      </p>
    </section>

    <section class="card" id="scenarios"></section>
  </main>

  <!-- ‚úÖ son -->
  <script src="sound.js"></script>

  <script>
    const STORAGE_KEY = "vivario_session_v1_1";

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function render() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        document.getElementById("finalMessage").textContent =
          "Session introuvable. Reviens au questionnaire.";
        return;
      }

      const session = JSON.parse(raw);

      document.getElementById("resultMeta").textContent =
        `Version ${session.version} ‚Ä¢ ${new Date(session.createdAt).toLocaleString("fr-FR")}`;

      document.getElementById("finalMessage").innerHTML =
        "<p>" + esc(session.finalMessage).replace(/\n\n/g, "</p><p>") + "</p>";

      const sc = document.getElementById("scenarios");
      const scenarios = Array.isArray(session.scenarios) ? session.scenarios : [];

      if (!scenarios.length) {
        sc.innerHTML = "<h3>Sc√©narios</h3><p class='muted'>Aucun sc√©nario disponible.</p>";
        return;
      }

      sc.innerHTML = "<h3>Sc√©narios</h3>" + scenarios.map(s => `
        <div class="scenario">
          <h4>${esc(s.title)}</h4>
          <div class="scenario-text">${esc(s.text).replace(/\n\n/g,"<br><br>")}</div>
        </div>
      `).join("");
    }

    // Respiration UX + audio sync
    let breathing = false;

    async function startBreath() {
      breathing = true;
      document.body.classList.add("breathing");

      // üîä d√©marre respiration (souffle + option modulation ambiance)
      await window.VivarioSound?.startBreathing?.({
        inhale: 4,
        hold: 0,
        exhale: 6,
        affectAmbience: false, // mets true si tu veux que la musique "respire" aussi
        affectBreath: true
      });
    }

    function stopBreath() {
      breathing = false;
      document.body.classList.remove("breathing");
      window.VivarioSound?.stopBreathing?.();
    }

    document.addEventListener("DOMContentLoaded", () => {
      render();

      document.getElementById("btnStartBreath").addEventListener("click", startBreath);
      document.getElementById("btnStopBreath").addEventListener("click", stopBreath);

      // Option: auto d√©marrage apr√®s 800ms (mais n√©cessite geste user pour l'audio)
      // setTimeout(() => startBreath(), 800);
    });
  </script>
</body>
</html>