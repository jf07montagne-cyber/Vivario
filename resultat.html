<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vivario ‚Äî R√©sultat</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);font-size:12px}
    .hrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between}
    .muted{opacity:.78}
    .small{font-size:12px}
    .section{margin-top:18px}

    .hero{
      margin-top:12px;
      padding:16px;
      border-radius:18px;
      background:linear-gradient(180deg, rgba(120,160,255,.18), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.12);
      position:relative;
      overflow:hidden;
    }
    .hero::after{
      content:"";
      position:absolute;
      inset:-40px -60px auto auto;
      width:240px;height:240px;
      background:radial-gradient(circle, rgba(120,160,255,.25), transparent 60%);
      filter:blur(2px);
      opacity:.9;
      pointer-events:none;
      animation:floaty 8s ease-in-out infinite;
    }
    @keyframes floaty{0%,100%{transform:translate(0,0)}50%{transform:translate(-18px,14px)}}
    .heroTitle{font-size:18px;line-height:1.4;margin:0}
    .heroSub{margin:8px 0 0;line-height:1.6;opacity:.92}

    .chiprow{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.10);font-size:12px;opacity:.9}

    .list{margin:10px 0 0;padding:0;list-style:none;display:grid;gap:10px}
    .item{padding:12px 12px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10)}
    .k{font-size:12px;opacity:.78;margin-bottom:6px}
    .v{font-size:15px;line-height:1.55;white-space:pre-wrap}

    .grid{display:grid;gap:10px;margin-top:10px}
    .sc{padding:14px;border-radius:18px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10)}
    .sc h3{margin:0 0 8px;font-size:16px}
    .sc p{margin:0;font-size:14px;line-height:1.65;opacity:.96;white-space:pre-wrap}
    .sc .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .miniBtn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:12px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);
      color:inherit;text-decoration:none;font-size:14px;cursor:pointer;
    }
    .miniBtn:hover{background:rgba(255,255,255,.09)}
    .miniBtn:active{transform:scale(.99)}

    /* Respiration */
    .micro{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px dashed rgba(255,255,255,.16);
    }
    .breathRow{display:flex;align-items:center;gap:14px;flex-wrap:wrap;margin-top:10px;}
    .breathWrap{width:120px;height:120px;border-radius:999px;display:grid;place-items:center;position:relative;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);overflow:hidden;}
    .breathGlow{position:absolute;inset:-30px;background:radial-gradient(circle, rgba(120,160,255,.22), transparent 60%);opacity:.9;pointer-events:none;}
    .breathBall{width:66px;height:66px;border-radius:999px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.20);transition:transform .6s ease;}
    .breathBall.run{animation:breathCycle 12s ease-in-out infinite;}
    @keyframes breathCycle{0%{transform:scale(1.00)}33%{transform:scale(1.38)}50%{transform:scale(1.38)}100%{transform:scale(1.00)}}
    .breathText{display:grid;gap:6px;min-width:220px;}
    .breathPhase{font-size:14px;opacity:.95;}
    .breathTimer{font-size:12px;opacity:.78;}
    .breathBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;}

    .finalNote{
      margin-top:14px;
      padding:14px;
      border-radius:18px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(20,20,25,.92);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:9999;
      max-width:92vw;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px);}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="hrow">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <h1 style="margin:0">Vivario</h1>
          <span class="badge">v1.1</span>
        </div>
        <!-- sound.js injecte aussi un bouton si n√©cessaire -->
        <button id="soundToggle" type="button" class="btn ghost" style="display:none">üîä</button>
      </div>

      <div class="hero">
        <p class="heroTitle" id="heroTitle">Merci d‚Äôavoir pris ce temps.</p>
        <p class="heroSub" id="heroSub">Tu peux avancer doucement, √† ton rythme.</p>
        <div class="chiprow" id="chipRow" style="display:none"></div>

        <div class="micro">
          <strong>üåø Micro-pause (facultatif)</strong>
          <div class="muted" style="margin-top:6px;line-height:1.55">
            Inspire 4s‚Ä¶ garde 2s‚Ä¶ expire 6s. Lance l‚Äôanimation si tu veux (30 secondes).
          </div>

          <div class="breathRow">
            <div class="breathWrap" aria-hidden="true">
              <div class="breathGlow"></div>
              <div id="breathBall" class="breathBall"></div>
            </div>
            <div class="breathText">
              <div class="breathPhase" id="breathPhase">Pr√™t ?</div>
              <div class="breathTimer" id="breathTimer">30s</div>
              <div class="breathBtns">
                <button class="miniBtn" id="breathStart" type="button">‚ñ∂Ô∏è D√©marrer</button>
                <button class="miniBtn" id="breathStop" type="button">‚è∏Ô∏è Stop</button>
                <button class="miniBtn" id="breathSkip" type="button">‚Ü™Ô∏è Passer</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="finalNote" id="finalNote" style="display:none">
        <div class="k">Juste pour toi</div>
        <div class="v" id="finalText"></div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="miniBtn" id="keepAll" type="button">üìå Je garde ce r√©sultat</button>
        </div>
      </div>

      <div class="section">
        <h2 style="margin:0">Ce que tu as partag√©</h2>
        <ul id="resumeList" class="list"></ul>
        <p id="resumeEmpty" class="muted" style="display:none;margin-top:10px">
          Aucun r√©sum√© √† afficher. (Refais une s√©ance.)
        </p>
      </div>

      <div class="section">
        <h2 style="margin:0">Sc√©narios adaptatifs</h2>
        <div id="scenarios" class="grid"></div>
        <p id="scEmpty" class="muted" style="display:none;margin-top:10px">Aucun sc√©nario √† afficher.</p>
      </div>

      <div class="btnrow">
        <a class="btn primary" href="questionnaire.html">Refaire une s√©ance</a>
        <a class="btn" href="avis.html">Donner un avis</a>
        <a class="btn ghost" href="accueil.html">‚Üê Accueil</a>
      </div>

      <div class="sep" style="margin-top:16px"></div>
      <p class="small muted" style="margin:0;line-height:1.55">
        Confidentialit√© : Vivario ne remplace pas un professionnel de sant√©.<br>
        Si tu es en d√©tresse ou en danger imm√©diat, contacte les urgences (15/112) ou un proche.
      </p>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Son -->
  <script src="sound.js" defer></script>

  <script>
    const STORAGE_KEY = "vivario_session_v1_1";

    const heroTitle = document.getElementById("heroTitle");
    const heroSub = document.getElementById("heroSub");
    const chipRow = document.getElementById("chipRow");

    const resumeList = document.getElementById("resumeList");
    const resumeEmpty = document.getElementById("resumeEmpty");
    const scWrap = document.getElementById("scenarios");
    const scEmpty = document.getElementById("scEmpty");

    const finalNote = document.getElementById("finalNote");
    const finalText = document.getElementById("finalText");
    const keepAll = document.getElementById("keepAll");

    const toast = document.getElementById("toast");

    // respiration
    const breathBall  = document.getElementById("breathBall");
    const breathPhase = document.getElementById("breathPhase");
    const breathTimer = document.getElementById("breathTimer");
    const breathStart = document.getElementById("breathStart");
    const breathStop  = document.getElementById("breathStop");
    const breathSkip  = document.getElementById("breathSkip");

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove("show"), 1600);
    }

    function readSession(){
      try{
        const v = localStorage.getItem(STORAGE_KEY);
        return v ? JSON.parse(v) : null;
      }catch(e){ return null; }
    }

    function safeArr(x){ return Array.isArray(x) ? x : []; }

    function labelTheme(id){
      const map = {
        travail:"travail", finances:"finances", couple:"couple", famille:"famille",
        enfants:"enfants", amis:"amis", sante:"sant√©", addiction:"addiction", evenement:"√©v√©nement"
      };
      return map[id] || id;
    }

    function niceTone(tone){
      const map = {
        stable:"üå§Ô∏è Stable",
        neutre:"üåô Neutre",
        flou:"üå´Ô∏è Flou",
        charge:"ü´ß Charg√©(e)",
        indetermine:"üß≠ √Ä ton rythme"
      };
      return map[tone] || "üß≠ √Ä ton rythme";
    }

    function niceNeed(id){
      const map = {
        mots:"mettre des mots",
        comprendre:"mieux comprendre",
        moins_seul:"se sentir moins seul(e)",
        normaliser:"se sentir l√©gitime",
        recul:"prendre du recul",
        presence:"juste √™tre ici",
        indetermine:"avancer sans forcer"
      };
      return map[id] || id;
    }

    function niceEnergy(id){
      const map = {
        lecture:"lire tranquillement",
        reflechir:"r√©fl√©chir un peu",
        parcourir:"juste parcourir",
        faible:"te pr√©server",
        indetermine:"y aller √† ton rythme"
      };
      return map[id] || id;
    }

    function buildFinal(profile){
      // 100% fiable: uniquement IDs du profile engine.js
      const root   = profile?.root || "clarification";
      const tone   = profile?.tone || "indetermine";
      const focus  = safeArr(profile?.focus);
      const besoin = safeArr(profile?.besoin);
      const energie= profile?.energie || "indetermine";
      const sortie = profile?.sortie || "identique";

      const focusTxt = focus.length ? focus.map(labelTheme).join(" et ") : "ce qui compte pour toi";

      // Ligne 1 : validation (tone + root)
      const L1 = {
        fatigue: {
          stable:"Tu sembles tenir, mais ton √©nergie m√©rite du respect.",
          neutre:"M√™me neutre, on peut sentir une fatigue en arri√®re-plan.",
          flou:"Quand c‚Äôest flou et fatiguant, le plus juste est de ralentir.",
          charge:"Tu portes beaucoup. Ici, tu peux d√©poser un peu.",
          indetermine:"On n‚Äôa pas besoin de tout nommer pour se m√©nager."
        },
        flou: {
          stable:"M√™me quand √ßa va, un peu de flou peut appara√Ætre. C‚Äôest normal.",
          neutre:"Ne pas savoir exactement est d√©j√† une information pr√©cieuse.",
          flou:"Le flou n‚Äôest pas un vide : c‚Äôest souvent trop de choses √† la fois.",
          charge:"Quand c‚Äôest flou et charg√©, l‚Äôesprit cherche juste de l‚Äôair.",
          indetermine:"On peut avancer sans direction nette, avec douceur."
        },
        protection: {
          stable:"Te pr√©server n‚Äôest pas exag√©rer. C‚Äôest une forme de sagesse.",
          neutre:"Se prot√©ger peut √™tre la bonne r√©ponse, m√™me sans urgence.",
          flou:"Se pr√©server, c‚Äôest parfois la seule fa√ßon de retrouver du calme.",
          charge:"Se pr√©server quand c‚Äôest lourd, c‚Äôest une force.",
          indetermine:"Le besoin de protection est l√©gitime, point."
        },
        resilience: {
          stable:"Tu avances. Et ce n‚Äôest pas rien.",
          neutre:"Tu fais ce que tu peux : √ßa compte.",
          flou:"M√™me dans le flou, tu continues : c‚Äôest une vraie tenue.",
          charge:"Tenir malgr√© la charge demande une √©nergie r√©elle.",
          indetermine:"Le simple fait d‚Äô√™tre l√† montre une pr√©sence √† toi-m√™me."
        },
        clarification: {
          stable:"M√™me quand tout va plut√¥t bien, faire le point peut te recentrer.",
          neutre:"Venir ici, m√™me neutre, c‚Äôest d√©j√† prendre soin de toi.",
          flou:"Clarifier ne veut pas dire r√©soudre : juste mieux situer.",
          charge:"Faire le point quand c‚Äôest charg√©, c‚Äôest d√©j√† respirer un peu.",
          indetermine:"On peut faire simple : un pas √† la fois."
        },
        sortie: {
          stable:"Merci d‚Äôavoir essay√©.",
          neutre:"Merci d‚Äôavoir pris ce temps.",
          flou:"Merci d‚Äôavoir tent√©, m√™me dans le flou.",
          charge:"Merci d‚Äô√™tre venu(e), m√™me fatigu√©(e).",
          indetermine:"Merci d‚Äô√™tre pass√©."
        }
      };
      const line1 = (L1[root] && L1[root][tone]) ? L1[root][tone] : "Merci d‚Äôavoir pris ce temps.";

      // Ligne 2 : ce qui ferait du bien (besoin)
      const needList = besoin.slice(0, 2).map(niceNeed);
      const line2 = needList.length
        ? `Aujourd‚Äôhui, ce qui pourrait te faire du bien : ${needList.join(" et ")}.`
        : `Aujourd‚Äôhui, tu peux simplement te concentrer sur ${focusTxt}.`;

      // Ligne 3 : permission + √©nergie + sortie
      let line3 = `Ton √©nergie te permet surtout de ${niceEnergy(energie)}. C‚Äôest suffisant.`;
      if (sortie === "pas_aide") line3 = `Si √ßa ne t‚Äôa pas aid√©(e) aujourd‚Äôhui, tu n‚Äôas rien rat√©. Reviens quand tu veux, ou cherche un autre espace qui te correspond.`;
      if (sortie === "stop") line3 = `Tu as le droit de t‚Äôarr√™ter l√†. Te pr√©server est une d√©cision valable.`;
      if (sortie === "clair") line3 = `Tu sembles un peu plus clair : garde cette clart√© comme une petite lampe, pas comme une obligation.`;
      if (sortie === "soulage") line3 = `Tu te sens un peu soulag√©(e) : laisse ce soulagement s‚Äôinstaller, sans le forcer.`;

      return `${line1}\n\n${line2}\n${line3}`;
    }

    function setHero(profile){
      const root = profile?.root || "clarification";
      const tone = profile?.tone || "indetermine";
      const titleMap = {
        fatigue:"Tu peux souffler un peu.",
        flou:"On peut faire simple.",
        protection:"Te pr√©server est l√©gitime.",
        resilience:"Tu as tenu, jusque-l√†.",
        clarification:"Merci d‚Äôavoir pris ce temps.",
        sortie:"Merci d‚Äôavoir essay√©."
      };
      heroTitle.textContent = titleMap[root] || "Merci d‚Äôavoir pris ce temps.";
      heroSub.textContent = `√âtat : ${niceTone(tone)} ‚Äî rien √† prouver, juste toi.`;
    }

    function renderChips(profile){
      const chips = [];
      if (profile?.focus?.length) chips.push(...profile.focus.slice(0,2).map(t => "üéØ " + labelTheme(t)));
      if (profile?.besoin?.length) chips.push(...profile.besoin.slice(0,2).map(b => "‚ú® " + niceNeed(b)));
      if (!chips.length) { chipRow.style.display = "none"; return; }

      chipRow.style.display = "flex";
      chipRow.innerHTML = "";
      chips.forEach(c => {
        const span = document.createElement("span");
        span.className = "chip";
        span.textContent = c;
        chipRow.appendChild(span);
      });
    }

    function makeAllText(session, phrase){
      const parts = [];
      parts.push("Vivario ‚Äî Mon r√©sultat\n");
      if (session?.answers?.length) {
        parts.push("R√©sum√© :");
        session.answers.forEach(a => {
          const q = a.question || a.role || a.id;
          parts.push(`- ${q}: ${a.answer}`);
        });
        parts.push("");
      }
      if (session?.scenarios?.length) {
        parts.push("Sc√©narios :");
        session.scenarios.forEach(s => {
          parts.push(`\n${s.title}\n${s.text}`);
        });
        parts.push("");
      }
      parts.push("Phrase finale :\n" + phrase);
      return parts.join("\n");
    }

    async function copyToClipboard(str){
      try{
        await navigator.clipboard.writeText(str);
        showToast("üìå Copi√© !");
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = str;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); showToast("üìå Copi√© !"); }
        catch(err){ showToast("Impossible de copier automatiquement."); }
        document.body.removeChild(ta);
      }
    }

    function render(){
      const session = readSession();
      if (!session) {
        setHero({root:"clarification", tone:"indetermine"});
        finalNote.style.display = "block";
        finalText.textContent = "Aucun r√©sultat trouv√©. Refais une s√©ance pour g√©n√©rer un r√©sum√© et des sc√©narios.";
        resumeEmpty.style.display = "block";
        scEmpty.style.display = "block";
        return;
      }

      const profile = session.profile || {};
      setHero(profile);
      renderChips(profile);

      const phrase = buildFinal(profile);
      finalNote.style.display = "block";
      finalText.textContent = phrase;

      keepAll.onclick = () => copyToClipboard(makeAllText(session, phrase));

      // R√©sum√©
      resumeList.innerHTML = "";
      const ans = safeArr(session.answers);
      if (!ans.length) {
        resumeEmpty.style.display = "block";
      } else {
        resumeEmpty.style.display = "none";
        ans.forEach(a => {
          const li = document.createElement("li");
          li.className = "item";
          const k = document.createElement("div");
          k.className = "k";
          k.textContent = a.question || a.role || "R√©ponse";
          const v = document.createElement("div");
          v.className = "v";
          v.textContent = a.answer || "";
          li.appendChild(k); li.appendChild(v);
          resumeList.appendChild(li);
        });
      }

      // Sc√©narios
      scWrap.innerHTML = "";
      const sc = safeArr(session.scenarios);
      if (!sc.length) {
        scEmpty.style.display = "block";
      } else {
        scEmpty.style.display = "none";
        sc.forEach(s => {
          const box = document.createElement("div");
          box.className = "sc";

          const h = document.createElement("h3");
          h.textContent = s.title || "Sc√©nario";

          const p = document.createElement("p");
          p.textContent = s.text || "";

          box.appendChild(h);
          box.appendChild(p);
          scWrap.appendChild(box);
        });
      }
    }

    // Respiration 30s ‚Äî manuel ‚Äî robuste
    let breathLeft = 30;
    let breathTick = null;
    let phaseTick = null;

    function stopBreath(msg){
      breathBall.classList.remove("run");
      clearInterval(breathTick); clearInterval(phaseTick);
      breathTick = null; phaseTick = null;
      breathLeft = 30;
      breathTimer.textContent = "30s";
      breathPhase.textContent = msg || "Pr√™t ?";
    }

    function startBreath(){
      stopBreath("Inspire‚Ä¶ (4s)");
      breathBall.classList.add("run");

      const phaseAt = (sec) => sec < 4 ? "Inspire‚Ä¶ (4s)" : (sec < 6 ? "Garde‚Ä¶ (2s)" : "Expire‚Ä¶ (6s)");
      const start = Date.now();

      phaseTick = setInterval(() => {
        const elapsed = (Date.now() - start) / 1000;
        const inCycle = elapsed % 12;
        breathPhase.textContent = phaseAt(inCycle);
      }, 200);

      breathTick = setInterval(() => {
        breathLeft -= 1;
        breathTimer.textContent = breathLeft + "s";
        if (breathLeft <= 0){
          stopBreath("Bien. Reviens doucement.");
          showToast("üåø Micro-pause termin√©e");
        }
      }, 1000);
    }

    breathStart.addEventListener("click", startBreath);
    breathStop.addEventListener("click", () => stopBreath("Pause."));
    breathSkip.addEventListener("click", () => stopBreath("OK. On passe."));

    render();
  </script>
</body>
</html>