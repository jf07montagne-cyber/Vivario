<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vivario ‚Äî R√©sultat</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);font-size:12px}
    .hrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between}
    .section{margin-top:18px}
    .list{margin:10px 0 0;padding:0;list-style:none;display:grid;gap:10px}
    .item{padding:12px 12px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10)}
    .k{font-size:12px;opacity:.75;margin-bottom:6px}
    .v{font-size:15px;line-height:1.45}
    .scGrid{display:grid;gap:10px;margin-top:10px}
    .sc{padding:14px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10)}
    .sc h3{margin:0 0 6px;font-size:16px}
    .sc p{margin:0;white-space:pre-line;font-size:14px;line-height:1.55;opacity:.95}
    .muted{opacity:.78}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .soft{padding:12px 14px;border-radius:16px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10)}
    .bigline{font-size:16px;line-height:1.6;margin:0}
    .mini{font-size:13px;opacity:.8;margin:6px 0 0}

    /* Respiration */
    .breathWrap{display:grid;gap:12px;margin-top:10px}
    .breathBox{display:grid;gap:10px;align-items:center;justify-items:center;padding:14px;border-radius:18px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10)}
    .orb{
      width:140px;height:140px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 16px 40px rgba(0,0,0,.25);
      transform:scale(0.92);
      transition:transform 800ms ease;
    }
    .orb.inhale{transform:scale(1.04)}
    .breathText{font-size:14px;opacity:.9;text-align:center;line-height:1.4}
    .breathBtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.10);font-size:12px;opacity:.9}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="hrow">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <h1 style="margin:0">Vivario</h1>
          <span class="badge">v1.1</span>
          <span id="toneChip" class="chip" style="display:none"></span>
        </div>
        <!-- Le bouton son est inject√© automatiquement par sound.js si absent -->
        <button id="soundToggle" type="button" class="btn ghost" style="display:none">üîä</button>
      </div>

      <p class="muted" style="margin-top:10px">
        Ce qui suit est un miroir doux de ton chemin ‚Äî sans jugement, sans obligation. Tu peux garder ce qui t‚Äôaide, laisser le reste.
      </p>

      <!-- Respiration (manuel / skippable) -->
      <div class="section">
        <h2 style="margin:0">Micro-pause (optionnelle)</h2>
        <div class="breathWrap">
          <div class="breathBox">
            <div id="orb" class="orb"></div>
            <div class="breathText">
              <div id="breathCue"><b>Si tu veux, prends 30 secondes.</b><br>Appuie sur ‚ÄúD√©marrer‚Äù, ou passe.</div>
              <div class="mini muted" id="breathTimer">0:00</div>
            </div>
            <div class="breathBtns">
              <button id="btnBreathStart" class="btn primary" type="button">D√©marrer</button>
              <button id="btnBreathStop" class="btn" type="button" disabled>Stop</button>
              <button id="btnBreathSkip" class="btn ghost" type="button">Passer</button>
            </div>
          </div>
          <div id="personalLine" class="soft" style="display:none">
            <p class="bigline" id="personalText"></p>
            <p class="mini muted" id="personalSub"></p>
          </div>
        </div>
      </div>

      <div class="section">
        <h2 style="margin:0">R√©sum√©</h2>
        <ul id="resumeList" class="list"></ul>
        <p id="resumeEmpty" class="muted" style="display:none;margin-top:10px">
          Aucun r√©sum√© √† afficher. (Refais une s√©ance.)
        </p>
      </div>

      <div class="section">
        <h2 style="margin:0">Sc√©narios</h2>
        <div id="scenarios" class="scGrid"></div>
        <p id="scEmpty" class="muted" style="display:none;margin-top:10px">Aucun sc√©nario √† afficher.</p>
      </div>

      <div class="section">
        <div class="soft">
          <p class="bigline" id="closingLine" style="margin:0"></p>
          <p class="mini muted" id="closingHint"></p>
        </div>
      </div>

      <div class="btnrow">
        <a class="btn primary" href="questionnaire.html">Refaire une s√©ance</a>
        <a class="btn" href="avis.html">Donner un avis</a>
        <a class="btn ghost" href="accueil.html">‚Üê Accueil</a>
      </div>

      <div class="sep" style="margin-top:16px"></div>

      <p class="small muted" style="margin:0">
        Confidentialit√© : Vivario ne remplace pas un professionnel de sant√©.<br>
        Si tu es en d√©tresse ou en danger imm√©diat, contacte les urgences (15/112) ou un proche.
      </p>
    </div>
  </div>

  <script src="sound.js" defer></script>

  <script>
    const STORAGE_KEY = "vivario_session_v1_1";

    const resumeList = document.getElementById("resumeList");
    const resumeEmpty = document.getElementById("resumeEmpty");
    const scWrap = document.getElementById("scenarios");
    const scEmpty = document.getElementById("scEmpty");

    const toneChip = document.getElementById("toneChip");
    const personalLine = document.getElementById("personalLine");
    const personalText = document.getElementById("personalText");
    const personalSub = document.getElementById("personalSub");

    const closingLine = document.getElementById("closingLine");
    const closingHint = document.getElementById("closingHint");

    function readSession(){
      try{
        const v = localStorage.getItem(STORAGE_KEY);
        return v ? JSON.parse(v) : null;
      }catch(e){ return null; }
    }

    // Utilitaires
    function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }
    function findAnswer(session, qid){
      if (!session || !Array.isArray(session.answers)) return null;
      return session.answers.find(a => String(a.id) === String(qid)) || null;
    }
    function answerLabel(session, qid){
      const a = findAnswer(session, qid);
      return a && a.answer ? String(a.answer) : "";
    }

    // ‚úÖ Phrase ultra personnalis√©e (uniquement √† partir des r√©ponses visibles)
    function buildPersonal(session){
      const q1 = answerLabel(session, "q1");
      const q2 = answerLabel(session, "q2");
      const q3 = answerLabel(session, "q3");
      const q5 = answerLabel(session, "q5");
      const q6 = answerLabel(session, "q6");
      const q7 = answerLabel(session, "q7");

      // Ton (affich√© en chip)
      let tone = "";
      if (q1.includes("stable") || q1.includes("Plut√¥t bien")) tone = "üå§Ô∏è Stable";
      else if (q1.includes("Neutre")) tone = "üåô Neutre";
      else if (q1.includes("perdu") || q1.includes("confus")) tone = "üå´Ô∏è Flou";
      else if (q1.includes("Charg√©")) tone = "ü´ß Charg√©";
      else tone = "üß≠ √Ä ton rythme";

      // Besoin (q5)
      let needLine = "";
      if (q5.includes("Mettre des mots")) needLine = "On va juste mettre des mots simples, sans forcer.";
      else if (q5.includes("comprendre")) needLine = "On va chercher un peu de clart√©, sans tout r√©soudre.";
      else if (q5.includes("moins seul")) needLine = "Tu n‚Äôas pas √† porter √ßa seul(e).";
      else if (q5.includes("normal")) needLine = "Ce que tu ressens a le droit d‚Äôexister tel quel.";
      else if (q5.includes("recul")) needLine = "Prendre du recul, m√™me petit, peut d√©j√† aider √† respirer.";
      else if (q5.includes("√™tre ici")) needLine = "√ätre l√†, maintenant, c‚Äôest d√©j√† suffisant.";
      else needLine = "On avance doucement, sans obligation.";

      // √ânergie (q6) -> style de recommandation
      let energyHint = "";
      if (q6.includes("Lire tranquillement")) energyHint = "Tu peux simplement lire et garder une phrase qui te fait du bien.";
      else if (q6.includes("R√©fl√©chir")) energyHint = "Si tu veux, note une id√©e cl√© (m√™me une seule).";
      else if (q6.includes("parcourir")) energyHint = "Tu peux survoler ‚Äî pas besoin d‚Äôaller loin aujourd‚Äôhui.";
      else if (q6.includes("Pas grand-chose")) energyHint = "Aujourd‚Äôhui, le plus juste est peut-√™tre de te pr√©server.";
      else energyHint = "Respecte ton rythme, m√™me s‚Äôil est flou.";

      // Th√®mes / v√©cu : on r√©utilise les mots de la personne (q2/q3)
      const themes = q2 ? `Ce qui occupe ton esprit : ${q2}.` : "";
      const vecu = q3 ? `Et √ßa se manifeste surtout comme : ${q3}.` : "";

      // Sortie (q7) -> cl√¥ture ultra personnalis√©e
      let end = "";
      if (q7.includes("plus clair")) end = "Tu as gagn√© un peu de clart√© ‚Äî garde-la comme une petite lampe, pas comme une exigence.";
      else if (q7.includes("soulag")) end = "Tu sens un peu de soulagement ‚Äî laisse-le s‚Äôinstaller, sans le bousculer.";
      else if (q7.includes("Identique")) end = "M√™me si tu te sens identique, tu as quand m√™me pris soin de toi en venant ici.";
      else if (q7.includes("Pas aid")) end = "Si √ßa ne t‚Äôa pas aid√© aujourd‚Äôhui, c‚Äôest OK. Tu n‚Äôas rien mal fait ‚Äî parfois il faut un autre espace, un autre moment.";
      else if (q7.includes("m‚Äôarr√™ter")) end = "Tu as le droit de t‚Äôarr√™ter l√†. Se pr√©server est une d√©cision valable.";
      else end = "Merci d‚Äôavoir pris ce temps.";

      // Phrase principale (tr√®s humaine)
      const main = pick([
        `L√†, maintenant : ${needLine}`,
        `Ce moment t‚Äôappartient. ${needLine}`,
        `On n‚Äôa pas besoin de tout comprendre aujourd‚Äôhui. ${needLine}`
      ]);

      return { tone, main, sub: energyHint, themes, vecu, end };
    }

    function render(){
      const session = readSession();
      if (!session) {
        resumeEmpty.style.display = "block";
        scEmpty.style.display = "block";
        closingLine.textContent = "Merci d‚Äô√™tre pass√©. Tu peux revenir quand tu veux.";
        closingHint.textContent = "Prends ce qui t‚Äôaide, laisse le reste.";
        return;
      }

      // Personnalisation
      const p = buildPersonal(session);
      toneChip.style.display = "inline-block";
      toneChip.textContent = p.tone;

      personalLine.style.display = "block";
      personalText.textContent = p.main;
      personalSub.textContent = p.sub;

      // R√©sum√©
      resumeList.innerHTML = "";
      const ans = Array.isArray(session.answers) ? session.answers : [];
      if (!ans.length) {
        resumeEmpty.style.display = "block";
      } else {
        resumeEmpty.style.display = "none";
        ans.forEach(a => {
          const li = document.createElement("li");
          li.className = "item";

          const k = document.createElement("div");
          k.className = "k";
          k.textContent = a.question || a.theme || "Ton chemin";

          const v = document.createElement("div");
          v.className = "v";
          v.textContent = a.answer || "";

          li.appendChild(k);
          li.appendChild(v);
          resumeList.appendChild(li);
        });
      }

      // Sc√©narios (adaptatifs, plusieurs)
      scWrap.innerHTML = "";
      const sc = Array.isArray(session.scenarios) ? session.scenarios : [];
      if (!sc.length) {
        scEmpty.style.display = "block";
      } else {
        scEmpty.style.display = "none";
        sc.forEach(s => {
          const box = document.createElement("div");
          box.className = "sc";

          const h = document.createElement("h3");
          h.textContent = s.title || "Sc√©nario";

          const pEl = document.createElement("p");
          pEl.textContent = s.text || "";

          box.appendChild(h);
          box.appendChild(pEl);
          scWrap.appendChild(box);
        });
      }

      // Cl√¥ture (tr√®s douce + unique)
      closingLine.textContent = p.end;
      const extra = [];
      if (p.themes) extra.push(p.themes);
      if (p.vecu) extra.push(p.vecu);
      closingHint.textContent = extra.length ? extra.join(" ") : "Tu peux revenir plus tard, sans pression.";
    }

    // Respiration manuelle
    (function(){
      const orb = document.getElementById("orb");
      const cue = document.getElementById("breathCue");
      const timer = document.getElementById("breathTimer");
      const btnStart = document.getElementById("btnBreathStart");
      const btnStop = document.getElementById("btnBreathStop");
      const btnSkip = document.getElementById("btnBreathSkip");

      let t = 0;
      let intv = null;
      let phase = "inhale"; // inhale/exhale
      const TOTAL = 30;     // 30s

      function fmt(sec){
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m}:${String(s).padStart(2,"0")}`;
      }

      function setPhase(p){
        phase = p;
        if (p === "inhale") {
          orb.classList.add("inhale");
          cue.innerHTML = "<b>Inspire‚Ä¶</b><br>doucement par le nez (4s)";
        } else {
          orb.classList.remove("inhale");
          cue.innerHTML = "<b>Expire‚Ä¶</b><br>lentement (6s)";
        }
      }

      function stop(){
        clearInterval(intv);
        intv = null;
        btnStart.disabled = false;
        btnStop.disabled = true;
        cue.innerHTML = "<b>Pause termin√©e.</b><br>Tu peux garder le r√©sultat, ou refaire une s√©ance.";
        orb.classList.remove("inhale");
      }

      function start(){
        if (intv) return;
        t = 0;
        timer.textContent = fmt(0);
        btnStart.disabled = true;
        btnStop.disabled = false;

        setPhase("inhale");
        let phaseTimer = 0;
        const inhaleLen = 4;
        const exhaleLen = 6;

        intv = setInterval(() => {
          t++;
          timer.textContent = fmt(t);

          phaseTimer++;
          if (phase === "inhale" && phaseTimer >= inhaleLen) { phaseTimer = 0; setPhase("exhale"); }
          else if (phase === "exhale" && phaseTimer >= exhaleLen) { phaseTimer = 0; setPhase("inhale"); }

          if (t >= TOTAL) {
            stop();
          }
        }, 1000);
      }

      btnStart.addEventListener("click", start);
      btnStop.addEventListener("click", stop);
      btnSkip.addEventListener("click", () => {
        stop();
        cue.innerHTML = "<b>OK.</b><br>On passe directement au r√©sultat.";
      });
    })();

    render();
  </script>
</body>
</html>