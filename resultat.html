<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vivario ‚Äî R√©sultat</title>
  <link rel="stylesheet" href="style.css?v=3" />
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="top">
        <div>
          <div class="brand">Vivario</div>
          <div class="subtle">v1.1 ‚Äî R√©sultat</div>
        </div>
        <span class="badge">S√©ance termin√©e</span>
      </div>

      <p class="lead">
        Merci d‚Äôavoir pris ce temps. Voici ton r√©sum√© et des sc√©narios adapt√©s √† tes r√©ponses.
        Tu peux refaire une s√©ance quand tu veux.
      </p>

      <!-- ===================== R√©sum√© ===================== -->
      <div class="section">
        <h2>R√©sum√©</h2>
        <ul id="resumeList" class="list"></ul>
        <p id="resumeEmpty" class="muted" style="display:none;margin-top:10px">
          Aucun r√©sum√© √† afficher. (Refais une s√©ance.)
        </p>
      </div>

      <!-- ===================== Sc√©narios ===================== -->
      <div class="section">
        <h2>Sc√©narios</h2>
        <div id="scenarios" class="scGrid"></div>
        <p id="scEmpty" class="muted" style="display:none;margin-top:10px">
          Aucun sc√©nario √† afficher.
        </p>
      </div>

      <!-- ===================== Respiration finale ===================== -->
      <div class="section">
        <div id="breathBox" class="breathBox">
          <h3>üå¨Ô∏è Micro-pause</h3>
          <p class="muted" style="margin-top:6px">
            Si tu veux, prenons 3 respirations ensemble. Tu peux aussi passer.
          </p>

          <div class="breathCircle" id="breathCircle" aria-hidden="true"></div>

          <div id="breathText" class="breathText">Pr√™t(e) ?</div>

          <div class="breathActions">
            <button id="btnBreathStart" class="btn primary" type="button">Commencer</button>
            <button id="btnBreathSkip" class="btn ghost" type="button">Passer</button>
          </div>

          <div class="breathNote">
            Astuce : inspire pendant que le cercle grandit‚Ä¶ expire quand il se rel√¢che.
          </div>
        </div>
      </div>

      <!-- ===================== Phrase finale (adapt√©e) ===================== -->
      <div class="section">
        <div class="finalCard">
          <div class="finalTitle">Pour terminer</div>
          <div id="finalLine" class="finalLine">
            Tu peux garder ce qui t‚Äôa parl√©, et laisser le reste. Un pas √† la fois.
          </div>
        </div>
      </div>

      <!-- ===================== Boutons ===================== -->
      <div class="btnrow">
        <a class="btn primary" href="questionnaire.html?v=3">Refaire une s√©ance</a>
        <a class="btn" href="avis.html?v=3">Donner un avis</a>
        <a class="btn ghost" href="accueil.html?v=3">‚Üê Accueil</a>
      </div>

      <div class="sep"></div>

      <p class="small muted" style="margin:0">
        <b>Confidentialit√© :</b> Vivario ne remplace pas un professionnel de sant√©.<br>
        Si tu es en d√©tresse ou en danger imm√©diat : 15 / 112, ou contacte un proche.
      </p>
    </div>
  </div>

  <script>
    // ===================== Rendu r√©sum√© + sc√©narios =====================
    const STORAGE_KEY = "vivario_session_v1_1";

    const resumeList = document.getElementById("resumeList");
    const resumeEmpty = document.getElementById("resumeEmpty");
    const scWrap = document.getElementById("scenarios");
    const scEmpty = document.getElementById("scEmpty");
    const finalLine = document.getElementById("finalLine");

    function readSession(){
      try{
        const v = localStorage.getItem(STORAGE_KEY);
        return v ? JSON.parse(v) : null;
      }catch(e){ return null; }
    }

    function pickFinalLine(session){
      // 100% bas√© sur les IDs (profile.*) => fiable
      const p = session && session.profile ? session.profile : null;
      if (!p) return "Tu peux garder ce qui t‚Äôa parl√©, et laisser le reste. Un pas √† la fois.";

      // sortie prioritaire
      if (p.sortie === "stop") return "Tu as le droit de t‚Äôarr√™ter ici. Revenir plus tard est aussi une force.";
      if (p.sortie === "pas_aide") return "Si √ßa n‚Äôa pas aid√© aujourd‚Äôhui, ce n‚Äôest pas un √©chec. Tu peux revenir quand tu veux.";

      // root dominant
      if (p.root === "fatigue") return "Aujourd‚Äôhui, la priorit√© peut √™tre la douceur. Tu n‚Äôas rien √† forcer.";
      if (p.root === "flou") return "M√™me un l√©ger √©claircissement compte. Tu n‚Äôas pas besoin d‚Äôavoir tout clair d‚Äôun coup.";
      if (p.root === "protection") return "Te pr√©server est une r√©ponse saine. Tu as le droit de ralentir.";
      if (p.root === "resilience") return "Ce que tu tiens m√©rite d‚Äô√™tre reconnu. Un petit pas vaut d√©j√† beaucoup.";

      // clarification
      return "Tu peux garder ce qui t‚Äôa parl√©, et laisser le reste. Un pas √† la fois.";
    }

    function render(){
      const session = readSession();

      // r√©sum√©
      resumeList.innerHTML = "";
      if (!session || !Array.isArray(session.answers) || !session.answers.length) {
        resumeEmpty.style.display = "block";
      } else {
        resumeEmpty.style.display = "none";
        session.answers.forEach(a => {
          const li = document.createElement("li");
          li.className = "item";

          const k = document.createElement("div");
          k.className = "k";
          // on montre le "role" ou un th√®me si dispo
          k.textContent = (a.role ? a.role : "Ton chemin");

          const q = document.createElement("div");
          q.className = "q";
          q.textContent = a.question || "";

          const v = document.createElement("div");
          v.className = "v";
          v.textContent = a.answer || "";

          li.appendChild(k);
          if (a.question) li.appendChild(q);
          li.appendChild(v);
          resumeList.appendChild(li);
        });
      }

      // sc√©narios
      scWrap.innerHTML = "";
      const sc = session && Array.isArray(session.scenarios) ? session.scenarios : [];
      if (!sc.length) {
        scEmpty.style.display = "block";
      } else {
        scEmpty.style.display = "none";
        sc.forEach(s => {
          const box = document.createElement("div");
          box.className = "sc";

          const h = document.createElement("h3");
          h.textContent = s.title || "Sc√©nario";

          const p = document.createElement("p");
          p.textContent = s.text || "";

          box.appendChild(h);
          box.appendChild(p);
          scWrap.appendChild(box);
        });
      }

      // phrase finale (adapt√©e)
      if (finalLine) finalLine.textContent = pickFinalLine(session);
    }

    render();
  </script>

  <script>
    // ===================== Respiration synchronis√©e (son + visuel) =====================
    (() => {
      const circle = document.getElementById("breathCircle");
      const text   = document.getElementById("breathText");
      const btnStart = document.getElementById("btnBreathStart");
      const btnSkip  = document.getElementById("btnBreathSkip");

      // Son court (loop) t√©l√©charg√© par toi
      const audio = new Audio("breath_cycle.mp3");
      audio.loop = true;
      audio.volume = 0.55;
      audio.preload = "auto";

      let phase = "inhale"; // inhale/exhale
      let cycles = 0;
      let timer = null;
      let running = false;

      function setPhase(next){
        if (!circle) return;

        circle.classList.remove("inhale","exhale");
        if (next === "inhale") {
          circle.classList.add("inhale");
          text.textContent = "Inspire doucement‚Ä¶";
        } else {
          circle.classList.add("exhale");
          text.textContent = "Expire lentement‚Ä¶";
        }
      }

      function step(){
        if (!running) return;

        if (phase === "inhale") {
          setPhase("inhale");
          phase = "exhale";
        } else {
          setPhase("exhale");
          phase = "inhale";
          cycles++;
        }

        // 3 cycles complets = inhale+exhale (donc 6 demi-phases)
        if (cycles >= 3) stop();
      }

      async function start(){
        if (running) return;
        running = true;
        cycles = 0;
        phase = "inhale";

        btnStart.disabled = true;
        btnSkip.disabled = false;

        // Tentative play (autoris√© car clic utilisateur)
        try { await audio.play(); } catch(e) { /* pas bloquant */ }

        // On lance imm√©diatement une phase puis toutes les 4s
        step();
        timer = setInterval(step, 4000); // synchro (4s)
      }

      function stop(){
        if (!running) {
          // stop ‚Äúsoft‚Äù m√™me si pas lanc√©
          text.textContent = "Tu peux passer √† la suite, √† ton rythme.";
          circle.classList.remove("inhale","exhale");
          return;
        }

        running = false;
        clearInterval(timer);
        timer = null;

        try { audio.pause(); } catch(e) {}

        circle.classList.remove("inhale","exhale");
        text.textContent = "Bien. Garde juste ce petit espace en toi.";
        btnStart.disabled = false;
      }

      btnStart.addEventListener("click", start);
      btnSkip.addEventListener("click", stop);
    })();
  </script>
</body>
</html>