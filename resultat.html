<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vivario ‚Äî R√©sultat</title>
  <link rel="stylesheet" href="style.css?v=900" />
</head>
<body class="page-result">

  <main class="wrap">
    <header class="top">
      <h1 class="brand">Vivario</h1>
      <p class="muted">Merci. Prends une seconde‚Ä¶</p>
    </header>

    <section class="card hero-card">
      <div class="hero-glow" aria-hidden="true"></div>

      <div class="hero-row">
        <div>
          <h2 class="hero-title">Tu peux souffler.</h2>
          <p class="muted hero-sub">
            Ces textes s‚Äôadaptent √† tes r√©ponses. Rien n‚Äôest envoy√© : tout reste sur ton appareil.
          </p>

          <div class="hero-tools">
            <div class="chips" id="chips"></div>

            <label class="coach-switch" title="Change le ton des sc√©narios">
              <input type="checkbox" id="coachToggle">
              <span class="coach-pill">
                <span class="coach-dot" aria-hidden="true"></span>
                Coach doux
              </span>
            </label>
          </div>
        </div>

        <div class="hero-orb" aria-hidden="true"></div>
      </div>

      <div class="actions hero-actions">
        <a class="btn primary" href="respiration.html?v=900">ü´Å Respiration guid√©e</a>
        <a class="btn ghost" href="accueil.html?v=900">‚Ü© Accueil</a>
      </div>
    </section>

    <section class="card breathe-card">
      <div class="breathe-orb" aria-hidden="true"></div>
      <div class="breathe-center" aria-hidden="true"></div>

      <h2 style="margin:0;">Ton r√©sultat</h2>
      <p class="muted" id="resultMeta" style="margin-top:6px;"></p>

      <div class="result-block bigtext" id="finalMessage"></div>
    </section>

    <section class="card" id="scenariosCard">
      <div class="tabs" role="tablist" aria-label="Sc√©narios Vivario">
        <button class="tab active" role="tab" aria-selected="true" data-tab="main">Juste pour toi</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="step">Un pas concret</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="calm">Apaisement</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="norm">Normalisation</button>
      </div>

      <div class="tabpanes">
        <div class="pane active" role="tabpanel" id="pane-main"></div>
        <div class="pane" role="tabpanel" id="pane-step"></div>
        <div class="pane" role="tabpanel" id="pane-calm"></div>
        <div class="pane" role="tabpanel" id="pane-norm"></div>
      </div>
    </section>

    <section class="card feedback-card">
      <h3 style="margin:0 0 6px;">Un avis rapide ?</h3>
      <p class="muted" style="margin:0 0 12px; line-height:1.45;">
        Ton retour m‚Äôaide √† rendre Vivario plus utile.
      </p>
      <div class="actions" style="margin-top:0;">
        <a class="btn primary" href="avis.html?v=900">‚úçÔ∏è Donner un avis</a>
        <a class="btn ghost" href="questionnaire.html?v=900">‚Üª Refaire le questionnaire</a>
      </div>
    </section>
  </main>

  <!-- ‚úÖ Bouton Ambiance UNIQUE -->
  <button
    id="vivarioAmbienceBtn"
    class="btn ghost ambience-toggle"
    data-ambience-toggle="1"
    aria-pressed="false">
    üîá Ambiance
  </button>

  <script src="sound.js?v=900"></script>
  <script src="ambiance.js?v=900"></script>

  <script>
    const STORAGE_KEY = "vivario_session_v1_1";
    const KEY_COACH = "vivario_coach_soft";

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    // ‚úÖ Anti-doublons de paragraphes (√©vite les r√©p√©titions visibles)
    function normalizeParagraphs(text){
      const parts = String(text || "")
        .split(/\n\s*\n/g)
        .map(p => p.trim())
        .filter(Boolean);

      const out = [];
      const seen = new Set();
      for (const p of parts) {
        const key = p.replace(/\s+/g, " ").trim();
        // on retire les doublons exacts
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(p);
      }
      return out;
    }

    function renderParagraphs(text){
      const parts = normalizeParagraphs(text);
      if (!parts.length) return "<p class='muted'>‚Äî</p>";
      return "<p>" + parts.map(esc).join("</p><p>") + "</p>";
    }

    function setActiveTab(key){
      document.querySelectorAll(".tab").forEach(btn => {
        const on = btn.dataset.tab === key;
        btn.classList.toggle("active", on);
        btn.setAttribute("aria-selected", on ? "true" : "false");
      });
      document.querySelectorAll(".pane").forEach(p => {
        p.classList.toggle("active", p.id === "pane-" + key);
      });
    }

    function themeLabel(id){
      const map = {
        stable: "Stable", neutre: "Neutre", flou: "Flou", charge: "Fatigue", indetermine: "Ind√©termin√©",
        lecture: "Lecture", reflechir: "R√©fl√©chir", parcourir: "Parcourir", faible: "Basse",
        travail: "Travail", finances: "Finances", couple: "Couple", famille: "Famille", enfants: "Enfants",
        amis: "Lien social", sante: "Sant√©", addiction: "Habitude", evenement: "√âv√©nement",
        multiple: "Multiple", rien_de_precis: "Faire le point", preferer_pas: "Discret"
      };
      return map[id] || id;
    }

    function chip(text){
      const span = document.createElement("span");
      span.className = "chip";
      span.textContent = text;
      return span;
    }

    function renderChips(session){
      const el = document.getElementById("chips");
      if (!el) return;
      el.innerHTML = "";

      const p = session.profile || {};
      const focus = Array.isArray(p.focus) ? p.focus : [];
      const tone = p.tone ? `√âtat : ${themeLabel(p.tone)}` : "";
      const energy = p.energie ? `√ânergie : ${themeLabel(p.energie)}` : "";

      if (tone) el.appendChild(chip(tone));
      focus.slice(0, 2).forEach(t => el.appendChild(chip(`Focus : ${themeLabel(t)}`)));
      if (energy) el.appendChild(chip(energy));
    }

    function fillPanes(session){
      const scenarios = Array.isArray(session.scenarios) ? session.scenarios : [];
      const map = {};
      scenarios.forEach(s => { if (s && s.key) map[s.key] = s; });

      function fillPane(key, fallbackTitle){
        const pane = document.getElementById("pane-" + key);
        const s = map[key];
        if (!pane) return;

        const title = esc(s?.title || fallbackTitle);
        const text = s?.text ? renderParagraphs(s.text) : "<p class='muted'>Indisponible.</p>";

        pane.innerHTML = `
          <h3 style="margin:0 0 10px;">${title}</h3>
          <div class="scenario-text">${text}</div>
        `;
      }

      fillPane("main", "Juste pour toi");
      fillPane("step", "Un pas concret");
      fillPane("calm", "Apaisement");
      fillPane("norm", "Normalisation");

      const mainTitle = map.main?.title;
      if (mainTitle) {
        const btnMain = document.querySelector('.tab[data-tab="main"]');
        if (btnMain) btnMain.textContent = mainTitle;
      }
    }

    function render(){
      const raw = localStorage.getItem(STORAGE_KEY);
      const finalEl = document.getElementById("finalMessage");
      const metaEl = document.getElementById("resultMeta");

      if (!raw) {
        finalEl.textContent = "Session introuvable. Reviens au questionnaire.";
        metaEl.textContent = "";
        return null;
      }

      const session = JSON.parse(raw);
      metaEl.textContent = `Version ${session.version} ‚Ä¢ ${new Date(session.createdAt).toLocaleString("fr-FR")}`;

      renderChips(session);
      finalEl.innerHTML = renderParagraphs(session.finalMessage);
      fillPanes(session);

      return session;
    }

    document.addEventListener("DOMContentLoaded", () => {
      render();

      document.querySelectorAll(".tab").forEach(btn => {
        btn.addEventListener("click", () => setActiveTab(btn.dataset.tab));
      });
      setActiveTab("main");

      // Coach switch (persistant)
      const coachToggle = document.getElementById("coachToggle");
      if (coachToggle) {
        coachToggle.checked = (localStorage.getItem(KEY_COACH) === "1");
        coachToggle.addEventListener("change", () => {
          localStorage.setItem(KEY_COACH, coachToggle.checked ? "1" : "0");
          window.location.href = "questionnaire.html?v=900";
        });
      }
    });
  </script>
</body>
</html>